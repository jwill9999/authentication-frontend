name: PR Quality Gate

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: pr-quality-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
      - name: Dependency review
        uses: actions/dependency-review-action@v4

  stable-deps:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Enforce stable dependency versions
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const sections = ['dependencies', 'devDependencies', 'optionalDependencies', 'peerDependencies'];
          const preReleasePattern = /(alpha|beta|rc|canary|next|preview)/i;
          const offenders = [];

          for (const section of sections) {
            const deps = pkg[section] || {};
            for (const [name, version] of Object.entries(deps)) {
              if (typeof version === 'string' && preReleasePattern.test(version)) {
                offenders.push(`${section}: ${name}@${version}`);
              }
            }
          }

          if (offenders.length) {
            console.error('Pre-release dependency versions are not allowed:');
            for (const item of offenders) console.error(`- ${item}`);
            process.exit(1);
          }

          console.log('Stable dependency policy check passed.');
          NODE

  npm-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm audit --omit=dev --audit-level=high

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run lint:ci

  typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run typecheck

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm test --silent

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run build

  docker-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Build and run frontend container
        run: |
          docker compose build frontend
          docker compose up -d frontend
      - name: Verify health endpoint
        run: |
          docker compose ps
          curl -fsS http://localhost:${FRONTEND_PORT:-80}/healthz
      - name: Cleanup
        if: always()
        run: docker compose down
