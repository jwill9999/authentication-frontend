name: Dependency Security Weekly

on:
  schedule:
    - cron: '0 4 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  weekly-security-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci

      - name: Stable dependency policy
        id: stable_deps
        continue-on-error: true
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const sections = ['dependencies', 'devDependencies', 'optionalDependencies', 'peerDependencies'];
          const preReleasePattern = /(alpha|beta|rc|canary|next|preview)/i;
          const offenders = [];

          for (const section of sections) {
            const deps = pkg[section] || {};
            for (const [name, version] of Object.entries(deps)) {
              if (typeof version === 'string' && preReleasePattern.test(version)) {
                offenders.push(`${section}: ${name}@${version}`);
              }
            }
          }

          if (offenders.length) {
            console.error('Pre-release dependency versions are not allowed:');
            for (const item of offenders) console.error(`- ${item}`);
            process.exit(1);
          }

          console.log('Stable dependency policy check passed.');
          NODE

      - name: npm audit (high/critical)
        id: audit
        continue-on-error: true
        run: npm audit --omit=dev --audit-level=high

      - name: Open issue if manual intervention is required
        if: steps.stable_deps.outcome == 'failure' || steps.audit.outcome == 'failure'
        uses: actions/github-script@v7
        env:
          STABLE_OUTCOME: ${{ steps.stable_deps.outcome }}
          AUDIT_OUTCOME: ${{ steps.audit.outcome }}
        with:
          script: |
            const date = new Date().toISOString().slice(0, 10);
            const title = `[Security] Weekly dependency check failed (${date})`;
            const body = [
              'The weekly dependency security workflow found issues that need manual intervention.',
              '',
              `- Stable dependency policy: ${process.env.STABLE_OUTCOME}`,
              `- npm audit (high/critical): ${process.env.AUDIT_OUTCOME}`,
              '',
              `Workflow run: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              '',
              'Please review the logs and address or triage findings.'
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });

            const exists = issues.some(issue => issue.title === title);
            if (!exists) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body
              });
            }

      - name: Fail workflow if checks failed
        if: steps.stable_deps.outcome == 'failure' || steps.audit.outcome == 'failure'
        run: |
          echo "Weekly dependency security checks failed. See logs and generated issue."
          exit 1
